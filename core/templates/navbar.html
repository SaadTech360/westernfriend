{% load wagtailsettings_tags %}
{% get_settings use_default_site=True %}

<nav class="bg-black text-white shadow-md sticky top-0 z-50" aria-label="Main navigation">
    <div class="container mx-auto px-2">
        <div class="flex flex-wrap items-center justify-between">
            <button class="xl:hidden p-1 my-1 rounded hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-300"
                    type="button"
                    data-collapse-toggle="navbarCollapse"
                    aria-controls="navbarCollapse"
                    aria-expanded="false"
                    aria-label="Toggle navigation">
                <i class="bi bi-list text-2xl" aria-hidden="true"></i>
            </button>

            <div class="hidden w-full xl:block xl:w-auto" id="navbarCollapse">
                <div class="flex flex-col xl:flex-row xl:items-center xl:space-x-1">
                    <ul class="menu menu-horizontal menu-compact bg-black website-links" role="menubar" aria-label="Site navigation links">
                        {{ settings.navigation.NavigationMenuSetting.menu_items }}
                    </ul>

                    <ul class="menu menu-horizontal menu-compact bg-black xl:ml-2" role="menubar" aria-label="Account navigation">
                        <li class="nav-item" role="none">
                            {% if user.is_authenticated %}
                                <form id="logout-form" method="post" action="{% url 'logout' %}?next={{ request.path }}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-ghost btn-sm text-white px-2 py-1 hover:bg-gray-700 focus:ring-2 focus:ring-gray-300 focus:outline-none" role="menuitem">Log out</button>
                                </form>
                            {% else %}
                                <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-ghost btn-sm text-white px-2 py-1 hover:bg-gray-700 focus:ring-2 focus:ring-gray-300 focus:outline-none" rel="nofollow" role="menuitem">
                                    Login
                                </a>
                            {% endif %}
                        </li>
                        {% if not user.is_authenticated %}
                            <li class="nav-item" role="none">
                                <a href="{% url 'django_registration_register' %}" class="btn btn-ghost btn-sm text-white px-2 py-1 hover:bg-gray-700 focus:ring-2 focus:ring-gray-300 focus:outline-none" rel="nofollow" role="menuitem">
                                    Register
                                </a>
                            </li>
                        {% endif %}
                    </ul>

                    <form action="{% url 'search' %}" method="get" class="relative mt-2 mb-3 xl:mb-0 xl:mt-0 xl:ml-2" role="search">
                        <div class="flex">
                            <label for="navbar-search-input" class="sr-only">Search</label>
                            <input id="navbar-search-input" name="query" type="search"
                                   class="bg-[#ffefed] border-0 rounded-l-lg py-1 px-1 text-sm text-gray-800 placeholder-gray-600 focus:outline-none focus:ring-2 focus:ring-[#aa3f2e] w-full"
                                   placeholder="Search" aria-label="Search" />
                            <button class="bg-gray-700 hover:bg-gray-800 text-white px-2 rounded-r-lg focus:ring-2 focus:ring-gray-300 focus:outline-none"
                                    type="submit" aria-label="Submit search">
                                <i class="bi bi-search" aria-hidden="true"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</nav>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const button = document.querySelector('[data-collapse-toggle="navbarCollapse"]');
        const menu = document.getElementById('navbarCollapse');

        // Function to find all focusable elements within an element
        function getFocusableElements(element) {
            return Array.from(
                element.querySelectorAll(
                    'a[href], button:not([disabled]), input:not([disabled]), textarea:not([disabled]), select:not([disabled]), details summary, [tabindex]:not([tabindex="-1"])'
                )
            ).filter(el => el.offsetParent !== null); // Ensure elements are visible
        }

        // Update ARIA expanded state and manage focus when toggling the menu
        button.addEventListener('click', function() {
            const isExpanded = menu.classList.toggle('hidden');
            button.setAttribute('aria-expanded', !isExpanded);

            if (!isExpanded) { // Menu is open
                const focusableElements = getFocusableElements(menu);
                if (focusableElements.length > 0) {
                    focusableElements[0].focus();
                }
                // Close menu when clicking outside
                document.addEventListener('click', function closeMenuOnClickOutside(event) {
                    if (!menu.contains(event.target) && !button.contains(event.target)) {
                        menu.classList.add('hidden');
                        button.setAttribute('aria-expanded', 'false');
                        // No need to explicitly return focus to button here, as Escape handler or next interaction will manage it.
                        document.removeEventListener('click', closeMenuOnClickOutside);
                    }
                });
            } else { // Menu is closed
                button.focus();
            }
        });

        // Handle Escape key to close menu
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && !menu.classList.contains('hidden')) {
                menu.classList.add('hidden');
                button.setAttribute('aria-expanded', 'false');
                button.focus();
            }
        });

        // Fix for dropdown carets not resetting when clicking outside
        document.addEventListener('click', function(event) {
            // Get all open details elements inside the navigation
            const openDropdowns = menu.querySelectorAll('details[open]');

            // Check if the click was outside of any open dropdown
            for (const dropdown of openDropdowns) {
                // If click target is not inside this dropdown, close it
                if (!dropdown.contains(event.target)) {
                    dropdown.removeAttribute('open');
                }
            }
        });
    });
</script>
